---
title: "2. Análise descritiva dos bancos de dados"
output: html_notebook
---

# 2. Análise descritiva dos bancos de dados

(Certifique-se de ter completado o arquivo "1. Carregando e limpando as bases de dados"

Agora que já criamos a base de dados, podemos fazer uma primeira análise descritiva dela. Vamos por categorias:

```{r}
#Instalando pacotes (não utilizados nos anteriores):
#install.packages("sf")
#install.packages("geobr")
#install.packages("scales")
#install.packages("formattable")
```

```{r, 'carregando_pacotes'}
#Carregando os pacotes que serão utilizados
library(here)
library(dplyr)
library(data.table)
library(ggplot2)
library(formattable)
```

```{r, 'upando_df'}
#Carregando a base de dados
df <- readRDS(here("Dados/df_agendaclima_municipal.RDS"))

df <- df %>% 
  mutate(Tipo = ifelse(Tipo == "requerimento (regimento antigo)", "requerimento", Tipo))

saveRDS(df, here("Dados/df_agendaclima_municipal.RDS"))
```

## 2.1 Municípios analisados

Para começar, faremos uma lista e um mapa dos municípios que serão analisados.

```{r, 'cria_lista_municipios'}
#Lista de municípios analisados
lista_municipios <- df %>% 
  select(Cod_IBGE_Mun, Nome_Municipio, UF) %>%
  unique()

write.csv(lista_municipios, here("Dados/lista_municipios.csv"))
```

### 2.1.1 Mapa dos municípios selecionados

```{r}
library(sf)
library(geobr)
#Listando os municípios presentes na seleção:

# Lê todos os municípios de 2023 apenas uma vez
mapa_brasil <- read_municipality(year = 2023)

# Filtra apenas os municípios presentes na lista
mapa_munic <- mapa_brasil %>%
  filter(code_muni %in% lista_municipios$Cod_IBGE_Mun) %>%
  select(code_muni, geom)

mapa_sapl <- ggplot() +
  geom_sf(data=mapa_brasil, alpha = 0.5, fill= "#666666", color = NA, size= .15)+
  geom_sf(data=mapa_munic, fill= "#D95F02", size=.15)+
  labs(title="Mapa dos Municípios selecionados para análise",
       caption='Fonte: Elaboração própria', size=8)+
  theme_linedraw()

ggsave(here("Figuras/2.1.1 MapaMunicipios.png"), mapa_sapl)

rm(mapa_brasil, mapa_munic, mapa_sapl)
```

Todas as figuras salvas podem ser vistas na pasta "Figuras"

### 2.1.2 Divisão dos Estados

Agora vamos fazer uma contagem do número de municípios por UF, e compará-la com o número de municípios que existem em cada estado

```{r}
#Criando base com número de municípios por UF
uf <- lista_municipios %>% 
  group_by(UF) %>% 
  summarise(n_selecionados = n()) %>% 
  arrange(UF) 

#Trazendo a lista completa de municípios por UF a partir da base "AdaptaBrasil"

AB_UF <- readRDS(here("Dados/AdaptaBrasil.RDS")) %>% 
  select(Cod_IBGE_Mun, Municipio_UF) %>% 
  mutate(UF = substr(Municipio_UF, nchar(Municipio_UF) - 1, nchar(Municipio_UF)))%>% 
  group_by(UF) %>% 
  summarise(total_UF = n()) %>% 
  arrange(UF)

#Juntando as bases
uf <- merge(uf, AB_UF, by = "UF", all = T) %>% 
  mutate(n_selecionados = ifelse(is.na(n_selecionados), 0, n_selecionados),
         Percentual_UF = n_selecionados/total_UF)

#Adicionando as regiões: 
regioes <- data.table(
  UF = c("AC", "AL", "AM", "AP", "BA", "CE", "DF", "ES", "GO", "MA", "MG", "MS", "MT", "PA", "PB", "PE", "PI", "PR", "RJ", "RN", "RO", "RR", "RS", "SC", "SE", "SP", "TO"), 
  Regiao = c("Norte", "Nordeste", "Norte", "Norte", "Nordeste", "Nordeste", "Centro-Oeste", "Sudeste", "Centro-Oeste", "Nordeste", "Sudeste", "Centro-Oeste", "Centro-Oeste", "Norte", "Nordeste", "Nordeste", "Nordeste", "Sul", "Sudeste", "Nordeste", "Norte", "Norte", "Sul", "Sul", "Nordeste", "Sudeste", "Norte")
)

cores <- data.table(Regiao = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul"),
                    Cores = c("#45D14A", "#D17C46", "#D1D145", "#D14568", "#45C3D1"))


regioes <- merge(regioes, cores, by = "Regiao")

uf <- merge(uf, regioes, by = "UF", all = T)


paleta_regiao <- setNames(uf$Cores, uf$Regiao)


rm(AB_UF, regioes, cores)
```

```{r}
#Plotando os gráficos
library(scales)


#Número absoluto de  Municípios, por UF

uf_num <- uf %>%
  ggplot(aes(x = reorder(UF, n_selecionados), y = n_selecionados, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  geom_text(aes(label = n_selecionados), vjust = -0.1,
              position = position_dodge(width = 0.5)) +
  labs(
    title = "Número de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Número de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2N_Municipios_UF.png"), uf_num)

rm(uf_num)
```

```{r}
#Percentual de municípios por UF

uf_percent <- uf %>%
  ggplot(aes(x = reorder(UF, Percentual_UF), y = Percentual_UF, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  labs(
    title = "Percentual de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Percentual de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2P_Municipios_UF.png"), uf_percent)

rm(uf_percent)
```

```{r}
#Reduzindo apenas para região
regiao <- uf %>% 
  group_by(Regiao, Cores) %>% 
  summarise(n_selecionados = sum(n_selecionados),
            total_UF = sum(total_UF)) %>% 
  mutate(Percentual_UF = n_selecionados/total_UF)

#Número por região
regiao_num <- regiao %>%
  ggplot(aes(x = reorder(Regiao, n_selecionados), y = n_selecionados, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  geom_text(aes(label = n_selecionados), vjust = -0.1,
              position = position_dodge(width = 0.5)) +
  labs(
    title = "Número de municípios presentes na seleção, por Região",
    x = "Unidades Federativas",
    y = "Número de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")


ggsave(here("Figuras/2.1.2N_Municipios_Regiao.png"), regiao_num)

rm(regiao_num)
```

```{r}
#Percentual por região

regiao_percent <- regiao %>%
  ggplot(aes(x = reorder(Regiao, Percentual_UF), y = Percentual_UF, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  labs(
    title = "Percentual de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Percentual de Municípios",
    fill = "Regiões"
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2P_Municipios_Regiao.png"), regiao_percent)

rm(regiao_percent, uf, regiao)
```

## 2.2 Variável dependente: Projetos

A seguir, vamos analisar as características da base de projetos:

### 2.2.1 Número total de projetos climáticos, por tipo

```{r}
#Tipos de projetos mais comuns

tiproj <- df %>%
  group_by(Tipo, Ano) %>% 
  summarise(n_al = n()) %>% 
  data.table()

#Criando paleta de cores para os projetos mais comuns
paleta_proposituras <- data.table(Tipo = c("indicacao", "requerimento", "pedido de providencia", "projeto de lei ordinaria", "protocolo", "mocao", "proposições", "projeto de lei executivo", "outros"),
                    Cores = c("#29BC8B", "#BD872A", "#2A42BD", "#BD2A2A", "#BD2A9D", "#712ABD", "#3C83C2", "#47BD2A", "#92A48E"))

#Adicionando paleta à tiproj:
tiproj <- tiproj %>% 
  mutate(Tipo = ifelse(Tipo %in% paleta_proposituras$Tipo, Tipo, "outros")) %>% 
  merge(paleta_proposituras, by = "Tipo", all.x = T)
  
tiproj_n <- tiproj %>%
  ggplot(aes(y = reorder(Tipo, n_al), x = n_al, fill = Tipo)) +
  geom_col() +
  labs(
    title = "Número de proposituras climáticas, por tipo",
    x = "Número de proposituras apresentadas",
    y = "Tipos de proposituras",
    fill = "Tipos de proposituras"
  ) +
  theme_classic() +
  theme(legend.position = "none")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.1.1N_Proposituras_Tipo.png"), tiproj_n)
  
rm(tiproj_n)
```

### 2.2.2 Projetos climáticos, por ano e tipo

```{r 'Tipos_Projetos'}
#Número de projetos por ano

tiproj_ano <- tiproj %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Tipo)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Número de proposituras climáticas, por ano", 
       x = "Anos",
       y = "Número de proposituras")+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.1.2N_Proposituras_Ano.png"), tiproj_ano)
  
rm(tiproj_ano)

```

### 2.2.3 Percentual dos tipos de proposituras na lista de projetos climáticos, por ano

```{r}

#Percentual de proposituras climáticas, por tipo
tiproj <- tiproj  %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al)) 
  

tiproj_pano <- tiproj %>% 
  group_by(Tipo, Ano) %>%
  summarise(p_al = sum(p_al)) %>% 
  ggplot(aes( x = `Ano`, y = p_al, fill = Tipo)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Distribuição dos tipos de proposituras climáticas, por ano", 
       y = 'Percentual de proposituras')+
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.2.3P_Tipos_Proposituras.png"), tiproj_pano)

rm(tiproj_pano)
```

### 2.2.4. Proporção dos tipos de proposituras climáticas em relação ao total de projetos deste tipo, por ano

```{r}
#Percentual em relação ao total de proposituras

tiproj <- df %>% 
  mutate(Tipo = ifelse(Tipo %in% paleta_proposituras$Tipo, Tipo, "outros")) %>% 
  group_by(Tipo, Data, Ano, total_tipo_proj_dia) %>% 
  summarise(n_proj_clima = n()) %>% 
  group_by(Ano, Tipo) %>% 
  summarise(n_proj_clima = sum(n_proj_clima),
            total_tipo_proj_ano = sum(total_tipo_proj_dia),
            p_proj_clima_ano = n_proj_clima/total_tipo_proj_ano) %>% 
  data.table()

ptipano <- tiproj %>% 
  ggplot(aes( x = Ano, y = p_proj_clima_ano, fill = Tipo)) + 
  geom_bar(position = "dodge2", stat = "identity")+
  theme_classic()+
  labs(title = "Proporção dos tipos de proposituras climáticas em relação ao total de projetos deste tipo, por ano", 
       y = 'Percentual de proposituras', 
       x = "Ano")+
  scale_y_continuous(labels = label_percent(accuracy = 1))+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)+
  facet_wrap(vars(Tipo))

ggsave(here("Figuras/2.2.4P_Tipos_Prop_Ano.png"), ptipano)

rm(ptipano)
```

### 2.2.5. Presença de termos climáticos #PAREI AQUI

```{r}
library(tidyr)
#Termos clima presentes

climatermos <- df %>% 
  select(Ano, Tipo, clima_termos) %>% 
  separate(clima_termos, c("clima_1", "clima_2", "clima_3", "clima_4", "clima_5", "clima_6", "clima_7"), sep = ", ", fill = "right") %>% 
  pivot_longer(starts_with("clima_"), names_to = "clima_names", names_prefix = "clima_", values_to = "clima_termos") %>% 
  filter(!is.na(clima_termos)) %>% 
  group_by(Ano, Tipo, clima_termos) %>% 
  summarise(n = n())
```

## 2.3 Variável explicativa: Desastres

```{r}
df <- readRDS(here("Dados/df.RDS"))
```

```{r, n_biomas}
df_desastres <- df %>% 
  filter(TDesastre == TRUE)  

p_df <- df_desastres %>%  
  group_by(Desastre, Bioma) %>%
  summarise(n = n()) %>% 
  group_by(Bioma) %>% 
  mutate(p_des = n / sum(n))%>% 
  mutate(Desastre = ifelse(p_des < 0.09, "Outros", Desastre))


graf1 <- p_df%>% 
  ggplot(aes( x = Bioma, y = p_des, fill =Desastre)) + 
  geom_bar(stat = "identity", position = "fill")+ 
  theme_linedraw()+
  labs(title = "Gráfico 1 - Distribuição dos tipos de desastre no 'Atlas', por Bioma")+
  scale_fill_brewer(palette = "Dark2")+
   ylab(label = "Percentual")+
  theme(legend.position="bottom",
        legend.title = element_blank())

ggsave(graf1, file = (here("Gráficos/graf1.png")), width = 20, height = 12, units = "cm")

plot(graf1)
```

```{r, 'n_ocorrencias'}

fig1 <- Desastres %>% 
  count(Desastre) %>% 
  data.frame() %>% 
  arrange(desc(n)) %>% 
  rename("Nº de ocorrências" = n) %>% 
  ggplot(aes(x = `Nº de ocorrências`, y = reorder(Desastre, `Nº de ocorrências`))) +
  geom_col() +
  theme_linedraw()+ 
  xlab(label = "Número de ocorrências") +
  ylab(label = "Tipo de desastre") +
  labs(title = "Figura 1- Número de ocorrências no 'Atlas' (1991-2022)")+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1)) +
  theme(legend.position="none", text=element_text(size=10))+ 
  scale_fill_brewer(palette = "Dark2")

plot(fig1)
```

```{r, 'Cronologia_Desastres'}
Desastres <- readRDS(here("Dados/Desastres.RDS"))

pDesastres <- Desastres %>%
  group_by(Desastre, Ano) %>% 
  summarise(n_al = n()) %>%
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al))

ggDesastres <- merge(Desastres, pDesastres, by = c('Desastre', 'Ano'), all.x = T) %>% 
  mutate(p_al = ifelse(is.na(p_al), 0, p_al))%>% 
  mutate(Desastre = ifelse(p_al < 0.06, "Outros", Desastre))

fig2 <- ggDesastres%>% 
  group_by(Ano, Desastre) %>% 
  summarise("Ocorrências" = n()) %>% 
  arrange(Ano) %>% 
  ggplot(aes(x = Ano, y = Ocorrências , fill = Desastre)) +
  geom_bar(stat="identity") +
  theme_linedraw()+
  xlab(label = "Ano") +
  ylab(label = "Número de ocorrências") +
  labs(title = "Figura 2 - Número de ocorrências no 'Atlas' (1991-2022)")+
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1),
        legend.position="bottom", text=element_text(size=10))+
  theme(legend.title = element_blank())+
  scale_fill_brewer(palette = "Dark2")
    

plot(fig2)
```

```{r, 'Decis populacionais'}

df_desastres <- readRDS(here("Dados/df.RDS")) %>% 
  filter(TDesastre == TRUE)  

p_df <- df_desastres %>%  
  group_by(Desastre, `Decil populacional`) %>%
  summarise(n = n()) %>% 
  group_by(`Decil populacional`) %>% 
  mutate(p_des = n / sum(n))%>% 
  mutate(Desastre = ifelse(p_des < 0.065, "Outros", Desastre))


fig3 <- p_df%>% 
  ggplot(aes( x = `Decil populacional`, y = p_des, fill =Desastre)) + 
  geom_bar(stat = "identity", position = "fill")+ 
  theme_linedraw()+
  labs(title = "Figura 3 - Distribuição dos tipos de desastre, por decil populacional")+
  scale_fill_brewer(palette = "Dark2")+
   ylab(label = "Percentual")+
  theme(legend.position="bottom",
        legend.title = element_blank())
plot(fig3)
```
