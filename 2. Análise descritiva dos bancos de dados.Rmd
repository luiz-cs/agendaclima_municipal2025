---
title: "2. Análise descritiva dos bancos de dados"
output: html_notebook
---

# 2. Análise descritiva dos bancos de dados

(Certifique-se de ter completado o arquivo "1. Carregando e limpando as bases de dados"

Agora que já criamos a base de dados, podemos fazer uma primeira análise descritiva dela. Vamos por categorias:

```{r, 'instalar_pacotes'}
#Instalando pacotes (não utilizados nos anteriores):
#install.packages("sf")
#install.packages("geobr")
#install.packages("scales")
#install.packages("formattable")
```

```{r, 'carregando_pacotes'}
#Carregando os pacotes que serão utilizados
library(here)
library(dplyr)
library(data.table)
library(ggplot2)
library(formattable)
```

```{r, 'upando_df'}
#Carregando a base de dados
df <- readRDS(here("Dados/df_agendaclima_municipal.RDS"))

df <- df %>% 
  mutate(Tipo = ifelse(Tipo == "requerimento (regimento antigo)", "requerimento", Tipo))

saveRDS(df, here("Dados/df_agendaclima_municipal.RDS"))
```

# 2.1 Municípios analisados

Para começar, faremos uma lista e um mapa dos municípios que serão analisados.

```{r, 'cria_lista_municipios'}
#Lista de municípios analisados
lista_municipios <- df %>% 
  select(Cod_IBGE_Mun, Nome_Municipio, UF) %>%
  unique()

write.csv(lista_municipios, here("Dados/lista_municipios.csv"))
```

### 2.1.1 Mapa dos municípios selecionados

```{r}
library(sf)
library(geobr)
#Listando os municípios presentes na seleção:

# Lê todos os municípios de 2023 apenas uma vez
mapa_brasil <- read_municipality(year = 2023)

# Filtra apenas os municípios presentes na lista
mapa_munic <- mapa_brasil %>%
  filter(code_muni %in% lista_municipios$Cod_IBGE_Mun) %>%
  select(code_muni, geom)

mapa_sapl <- ggplot() +
  geom_sf(data=mapa_brasil, alpha = 0.5, fill= "#666666", color = NA, size= .15)+
  geom_sf(data=mapa_munic, fill= "#D95F02", size=.15)+
  labs(title="Mapa dos Municípios selecionados para análise",
       caption='Fonte: Elaboração própria', size=8)+
  theme_linedraw()

ggsave(here("Figuras/2.1.1 MapaMunicipios.png"), mapa_sapl)

rm(mapa_brasil, mapa_munic, mapa_sapl)
```

Todas as figuras salvas podem ser vistas na pasta "Figuras"

### 2.1.2 Divisão dos Estados

Agora vamos fazer uma contagem do número de municípios por UF, e compará-la com o número de municípios que existem em cada estado

```{r}
#Criando base com número de municípios por UF
uf <- lista_municipios %>% 
  group_by(UF) %>% 
  summarise(n_selecionados = n()) %>% 
  arrange(UF) 

#Trazendo a lista completa de municípios por UF a partir da base "AdaptaBrasil"

AB_UF <- readRDS(here("Dados/AdaptaBrasil.RDS")) %>% 
  select(Cod_IBGE_Mun, Municipio_UF) %>% 
  mutate(UF = substr(Municipio_UF, nchar(Municipio_UF) - 1, nchar(Municipio_UF)))%>% 
  group_by(UF) %>% 
  summarise(total_UF = n()) %>% 
  arrange(UF)

#Juntando as bases
uf <- merge(uf, AB_UF, by = "UF", all = T) %>% 
  mutate(n_selecionados = ifelse(is.na(n_selecionados), 0, n_selecionados),
         Percentual_UF = n_selecionados/total_UF)

#Adicionando as regiões: 
regioes <- data.table(
  UF = c("AC", "AL", "AM", "AP", "BA", "CE", "DF", "ES", "GO", "MA", "MG", "MS", "MT", "PA", "PB", "PE", "PI", "PR", "RJ", "RN", "RO", "RR", "RS", "SC", "SE", "SP", "TO"), 
  Regiao = c("Norte", "Nordeste", "Norte", "Norte", "Nordeste", "Nordeste", "Centro-Oeste", "Sudeste", "Centro-Oeste", "Nordeste", "Sudeste", "Centro-Oeste", "Centro-Oeste", "Norte", "Nordeste", "Nordeste", "Nordeste", "Sul", "Sudeste", "Nordeste", "Norte", "Norte", "Sul", "Sul", "Nordeste", "Sudeste", "Norte")
)

cores <- data.table(Regiao = c("Norte", "Nordeste", "Centro-Oeste", "Sudeste", "Sul"),
                    Cores = c("#45D14A", "#D17C46", "#D1D145", "#D14568", "#45C3D1"))


regioes <- merge(regioes, cores, by = "Regiao")

uf <- merge(uf, regioes, by = "UF", all = T)


paleta_regiao <- setNames(uf$Cores, uf$Regiao)


rm(AB_UF, regioes, cores)
```

```{r}
#Plotando os gráficos
library(scales)


#Número absoluto de  Municípios, por UF

uf_num <- uf %>%
  ggplot(aes(x = reorder(UF, n_selecionados), y = n_selecionados, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  geom_text(aes(label = n_selecionados), vjust = -0.1,
              position = position_dodge(width = 0.5)) +
  labs(
    title = "Número de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Número de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2N_Municipios_UF.png"), uf_num)

rm(uf_num)
```

```{r}
#Percentual de municípios por UF

uf_percent <- uf %>%
  ggplot(aes(x = reorder(UF, Percentual_UF), y = Percentual_UF, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  labs(
    title = "Percentual de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Percentual de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2P_Municipios_UF.png"), uf_percent)

rm(uf_percent)
```

```{r}
#Reduzindo apenas para região
regiao <- uf %>% 
  group_by(Regiao, Cores) %>% 
  summarise(n_selecionados = sum(n_selecionados),
            total_UF = sum(total_UF)) %>% 
  mutate(Percentual_UF = n_selecionados/total_UF)

#Número por região
regiao_num <- regiao %>%
  ggplot(aes(x = reorder(Regiao, n_selecionados), y = n_selecionados, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  geom_text(aes(label = n_selecionados), vjust = -0.1,
              position = position_dodge(width = 0.5)) +
  labs(
    title = "Número de municípios presentes na seleção, por Região",
    x = "Unidades Federativas",
    y = "Número de Municípios",
    fill = "Regiões"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")


ggsave(here("Figuras/2.1.2N_Municipios_Regiao.png"), regiao_num)

rm(regiao_num)
```

```{r}
#Percentual por região

regiao_percent <- regiao %>%
  ggplot(aes(x = reorder(Regiao, Percentual_UF), y = Percentual_UF, fill = Regiao)) +
  geom_col() +
  scale_fill_manual(values = paleta_regiao) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  labs(
    title = "Percentual de municípios presentes na seleção, por UF",
    x = "Unidades Federativas",
    y = "Percentual de Municípios",
    fill = "Regiões"
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom")

ggsave(here("Figuras/2.1.2P_Municipios_Regiao.png"), regiao_percent)

rm(regiao_percent, uf, regiao)
```

## 2.2 Variável dependente: Projetos

A seguir, vamos analisar as características da base de projetos:

### 2.2.1 Número total de projetos climáticos, por tipo

```{r}
#Tipos de projetos mais comuns

tiproj <- df %>%
  group_by(Tipo, Ano) %>% 
  summarise(n_al = n()) %>% 
  data.table()

#Criando paleta de cores para os projetos mais comuns
paleta_proposituras <- data.table(Tipo = c("indicacao", "requerimento", "pedido de providencia", "projeto de lei ordinaria", "protocolo", "mocao", "proposições", "projeto de lei executivo", "outros"),
                    Cores = c("#29BC8B", "#BD872A", "#2A42BD", "#BD2A2A", "#BD2A9D", "#712ABD", "#3C83C2", "#47BD2A", "#92A48E"))

#Adicionando paleta à tiproj:
tiproj <- tiproj %>% 
  mutate(Tipo = ifelse(Tipo %in% paleta_proposituras$Tipo, Tipo, "outros")) %>% 
  merge(paleta_proposituras, by = "Tipo", all.x = T)
  
tiproj_n <- tiproj %>%
  ggplot(aes(y = reorder(Tipo, n_al), x = n_al, fill = Tipo)) +
  geom_col() +
  labs(
    title = "Número de proposituras climáticas, por tipo",
    x = "Número de proposituras apresentadas",
    y = "Tipos de proposituras",
    fill = "Tipos de proposituras"
  ) +
  theme_classic() +
  theme(legend.position = "none")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.2.1N_Proposituras_Tipo.png"), tiproj_n)
  
rm(tiproj_n)
```

### 2.2.2 Projetos climáticos, por ano e tipo

```{r 'Tipos_Projetos'}
#Número de projetos por ano

tiproj_ano <- tiproj %>% 
  ggplot(aes( x = `Ano`, y = n_al, fill = Tipo)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Número de proposituras climáticas, por ano", 
       x = "Anos",
       y = "Número de proposituras")+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.2.2N_Proposituras_Ano.png"), tiproj_ano)
  
rm(tiproj_ano)

```

### 2.2.3 Percentual dos tipos de proposituras na lista de projetos climáticos, por ano

```{r}

#Percentual de proposituras climáticas, por tipo
tiproj <- tiproj  %>% 
  group_by(Ano) %>%
  mutate(p_al = n_al / sum(n_al)) 
  

tiproj_pano <- tiproj %>% 
  group_by(Tipo, Ano) %>%
  summarise(p_al = sum(p_al)) %>% 
  ggplot(aes( x = `Ano`, y = p_al, fill = Tipo)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Distribuição dos tipos de proposituras climáticas, por ano", 
       y = 'Percentual de proposituras')+
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)

ggsave(here("Figuras/2.2.3P_Tipos_Proposituras.png"), tiproj_pano)

rm(tiproj_pano)
```

### 2.2.4. Proporção dos tipos de proposituras climáticas em relação ao total de projetos deste tipo, por ano

```{r}
#Percentual em relação ao total de proposituras

tiproj <- df %>% 
  mutate(Tipo = ifelse(Tipo %in% paleta_proposituras$Tipo, Tipo, "outros")) %>% 
  group_by(Tipo, Data, Ano, total_tipo_proj_dia) %>% 
  summarise(n_proj_clima = n()) %>% 
  group_by(Ano, Tipo) %>% 
  summarise(n_proj_clima = sum(n_proj_clima),
            total_tipo_proj_ano = sum(total_tipo_proj_dia),
            p_proj_clima_ano = n_proj_clima/total_tipo_proj_ano) %>% 
  data.table()

ptipano <- tiproj %>% 
  ggplot(aes( x = Ano, y = p_proj_clima_ano, fill = Tipo)) + 
  geom_bar(position = "dodge2", stat = "identity")+
  theme_classic()+
  labs(title = "Proporção dos tipos de proposituras climáticas em relação ao total de projetos deste tipo, por ano", 
       y = 'Percentual de proposituras', 
       x = "Ano")+
  scale_y_continuous(labels = label_percent(accuracy = 1))+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_proposituras$Cores, limits = paleta_proposituras$Tipo)+
  facet_wrap(vars(Tipo))

ggsave(here("Figuras/2.2.4P_Tipos_Prop_Ano.png"), ptipano)

rm(ptipano, tiproj)
```

### 2.2.5. Presença de termos climáticos 

```{r}
#Termos clima presentes

climatermos <- df %>% 
  select(Ano, Tipo, clima_termos) %>% 
  separate(clima_termos, c("clima_1", "clima_2", "clima_3", "clima_4", "clima_5", "clima_6", "clima_7"), sep = ", ", fill = "right") %>% 
  pivot_longer(starts_with("clima_"), names_to = "clima_names", names_prefix = "clima_", values_to = "clima_termos") %>% 
  filter(!is.na(clima_termos)) %>% 
  group_by(Ano, Tipo, clima_termos) %>% 
  summarise(n = n()) %>% 
  mutate(Categoria = case_when( #Adicionando categorias
  #Chuvas:
  clima_termos %in% c(" pluvial", " pluviais", " chuva", " fortes chuvas",  " chuvoso") ~ "Chuvas",
  #Alagamentos e Inundações:
  clima_termos %in% c(" alagamento",  " inundação", " inundações", " enxurrada", " enchente") ~ "Alagamentos e Inundações",
  #Movimentos de Massa:
  clima_termos %in% c(" deslizamento", " soterramento", " desabamento", " erosão") ~ "Movimentos de Massa",
  #Secas:
  clima_termos %in% c(" seca", " estiagem", " estiagens" ) ~ "Secas",
  #Clima:
  clima_termos %in% c(" clima", " adaptação climática", " aquecimento global", " mitigação", " eventos climáticos extremos", " descarbonização", " transição energética", " carbono", " efeito estufa") ~ "Clima",
  #Ventos:
  clima_termos == " vento" ~ "Ventos",
  #Incêndios:
  clima_termos == " incêndio" ~ "Incêndios",
    #Defesa Civil
    clima_termos == " defesa civil" ~ "Defesa Civil")) %>% 
  ungroup()

paleta_climatermos <- climatermos %>%
  select(Categoria) %>% 
  unique() %>% 
  mutate(Cores = case_when(
    Categoria == "Chuvas" ~ "#24D7FF",
    Categoria == "Alagamentos e Inundações" ~ "#242BFF",
    Categoria == "Movimentos de Massa" ~ "#FF7424",
    Categoria == "Secas" ~ "#F4FF24",
    Categoria == "Clima" ~ "#8A24FF",
    Categoria == "Ventos" ~ "#FF24BA",
    Categoria == "Incêndios" ~ "#FF2424",
    Categoria == "Defesa Civil" ~ "#45FF24"))
  

```

### 2.2.6 Contagem termos climáticos

```{r}
#Gráfico contagem:

n_ct <- climatermos %>%
  group_by(clima_termos, Categoria) %>% 
  summarise(n = sum(n)) %>% 
  ggplot(aes(y = reorder(clima_termos, n), x = n, fill = Categoria)) +
  geom_col() +
  labs(
    title = "Número de menções a termos climáticos nas proposituras",
    x = "Número de menções",
    y = "Termos climáticos",
    fill = "Categorias"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_climatermos$Cores, limits = paleta_climatermos$Categoria)

ggsave(here("Figuras/2.2.5N_climatermos.png"), n_ct)
  
rm(n_ct)
```

### 2.2.7 Contagem termos climáticos, por ano

```{r}

ct_nano <- climatermos %>%
  ggplot(aes(y = n, x = Ano, fill = Categoria)) +
  geom_col() +
  labs(
    title = "Número de menções a termos climáticos nas proposituras, por ano",
    x = "Ano",
    y = "Número de menções",
    fill = "Categorias de Termos"
  ) +
  theme_classic() +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_climatermos$Cores, limits = paleta_climatermos$Categoria)

ggsave(here("Figuras/2.2.6N_climatermos_ano.png"), ct_nano)
  
rm(ct_nano)
```

### 2.2.8 Percentual de proposituras climáticas, por ano e tipo

```{r}
#Percentual de proposituras climáticas, por tipo

ct_pano <- climatermos %>% 
  group_by(Categoria, Ano) %>%
  summarise(n_al = n()) %>% 
  group_by(Ano) %>% 
  mutate(p_al = n_al/sum(n_al)) %>% 
  ggplot(aes( x = `Ano`, y = p_al, fill = Categoria)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Distribuição das ocorrências dos termos climáticos, por ano", 
       y = 'Percentual dos termos')+
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_climatermos$Cores, limits = paleta_climatermos$Categoria)


ggsave(here("Figuras/2.2.7P_Categorias_Termos_ano.png"), ct_pano)

rm(ct_pano, climatermos)
```

### 2.2.9 Tipos de propositura x Termos climáticos

Agora, vamos cruzar as duas informações para compreender como elas se relacionam.

```{r}

tiproj_termosclima <- climatermos %>%
  mutate(Tipo = ifelse(Tipo %in% paleta_proposituras$Tipo, Tipo, "outros")) %>% 
  group_by(Tipo) %>%
  mutate(p_al = n / sum(n)) %>% 
  group_by(Tipo, Categoria) %>%
  summarise(p_al = sum(p_al),
            n_al = sum(n)) %>% 
  ggplot(aes( y = reorder(`Tipo`, n_al), x = p_al, fill = Categoria)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Distribuição dos termos climáticas, por tipo de propositura", 
       x = 'Percentual', 
       y = "Tipos de proposituras")+
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_climatermos$Cores, limits = paleta_climatermos$Categoria)

ggsave(here("Figuras/2.2.6P_Tipos_Proposituras_Termos_Climáticos.png"), tiproj_termosclima)

rm(tiproj_termosclima, climatermos)
```

## 2.3 Variáveis explicativas: 

## 2.3.1 Desastres

### Linha do tempo desastres na base analisada (números absolutos)

Ocorrências

```{r}
#Recuperar base Desastres
Desastres <- readRDS(here("Dados/Desastres.RDS"))
#Tipos de projetos mais comuns

dfdesastres <- Desastres %>%
  filter(Cod_IBGE_Mun %in% lista_municipios$Cod_IBGE_Mun) %>% 
  group_by(Desastre, Ano) %>% 
  summarise(n = n(),
            DH_MORTOS = sum(DH_MORTOS)) %>% 
  data.table()

#Criando paleta de cores para os projetos mais comuns
paleta_desastres <- data.table(Tipo = c("Estiagem e Seca", "Enxurradas", "Chuvas Intensas", "Inundações",  "Vendavais e Ciclones", "Movimento de Massa", "Alagamentos", "Granizo", "Incêndio Florestal", "Erosão", "Onda de Calor e Baixa Umidade", "Onda de Frio", "Tornado"),
                    Cores = c("#E9D200", "#00E89F", "#009BE8", "#001BE8",  "#C500E8", "#D46600", "#00C213", "#2AEEF5", "#B00000", "#6D2AF5", "#C5F52A", "#4AABD1", "#71CEF3"))

```

```{r, anos_desastres}

ndes_ano <- dfdesastres %>%
  ggplot(aes(y = n, x = Ano, fill = Desastre)) +
  geom_col() +
  labs(
    title = "Número de desastres na seleção, por categoria de desastres e anos",
    y = "Número de desastres",
    x = "Ano",
    fill = "Categorias de Desastres"
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_desastres$Cores, limits = paleta_desastres$Tipo)


ggsave(here("Figuras/2.3.1N_Desastres_Anos.png"), ndes_ano)
  
rm(ndes_ano)
```

Letalidade

```{r}

  
nlet_ano <- dfdesastres %>%
  ggplot(aes(y = DH_MORTOS, x = Ano, fill = Desastre)) +
  geom_col() +
  labs(
    title = "Número de óbitos registrados nos municípios selecionados, por categoria de desastres e anos",
    y = "Número de óbitos",
    x = "Ano",
    fill = "Categorias de Desastres"
  ) +
  theme_linedraw() +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_desastres$Cores, limits = paleta_desastres$Tipo)


ggsave(here("Figuras/2.3.2N_Des_Letalidade_Anos.png"), nlet_ano)
  
rm(nlet_ano )
```

### Comparação do percentual de desastres na base e no Brasil (percentuais)

Ocorrências

```{r}
#Adicionando informações do resto do Brasil

totalDes <- Desastres %>%
  group_by(Desastre, Ano) %>% 
  summarise(n_Brasil = n(),
            DH_MORTOS = sum(DH_MORTOS)) %>% 
  group_by(Ano) %>% 
  mutate(p_Brasil = n_Brasil/sum(n_Brasil),
         pc_obitos_Brasil = DH_MORTOS/sum(DH_MORTOS)) %>%
  rename("obitos_Brasil" = DH_MORTOS) %>% 
  data.table()

#Novo Desastres  
dfdesastres <- dfdesastres %>% 
  rename("n_selecao" = n, 
         "obitos_selecao" = DH_MORTOS) %>% 
  group_by(Ano) %>% 
  mutate(p_selecao = n_selecao/sum(n_selecao), 
         pc_obitos_selecao = obitos_selecao/sum(obitos_selecao)) %>% 
    merge(totalDes, by = c("Desastre", "Ano"), all= T) %>% 
  replace(is.na(.), 0)



```

```{r}
p_des_ano_cat <- dfdesastres %>% 
  pivot_longer(cols = starts_with("p_"), names_prefix = "p_", names_to = "origem", values_to = "Percentual") %>% 
  ggplot(aes( x = `Desastre`, y = Percentual, fill = Desastre, group = Desastre)) + 
  geom_bar(stat = "identity")+ 
  theme_classic()+
  labs(title = "Percentual das ocorrências de desastres, por ano e categoria", 
       y = 'Percentual de ocorrências', 
       x = "Anos")+
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  theme(legend.position = "bottom")+
  scale_fill_manual(values = paleta_desastres$Cores, limits = paleta_desastres$Tipo) + 
  facet_wrap(~origem)


ggsave(here("Figuras/2.3.3P_Categoria_Desastres_Ano.png"), p_des_ano_cat)

rm(Desastres, totalDes, p_des_ano_cat)
```

Letalidade

```{r}

```

## 2.3.2 Riscos Climáticos

### Histogramas de riscos climáticos por área

```{r}

```

### Histograma de riscos climáticos por componentes

```{r}

```

## 2.3.3 Presença de OCSs nos Municípios

### Histograma da distribuição de OSCs: base vs Brasil

## 2.3.4 Orçamento dos municípios

### Histograma do orçamento dos municípios vs Brasil

# 2.4 Cruzando as variáveis

## 2.4.1 Proposituras x Desastres

### 2.4.1.1 Nº Proposituras x Dias após Desastre

### 2.4.1.2 Tipo de Proposituras x Dias após Desastre

## 2.4.2 % Proposituras Município x Risco Climático

## 2.4.3 % Proposituras Município x Nº de OSCs  

## 2.4.4  %Proposituras climáticas x Orçamento municipal
