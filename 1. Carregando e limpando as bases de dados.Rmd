---
title: "1. Carregando e limpando as bases de dados"
output: html_document
---

**Atenção**: Não esqueça de rodar antes o arquivo "0"

# 1. Carregando e limpando as bases de dados

## 1.1 Importando pacotes

Antes de começar, estes são os pacotes que serão necessários para manipulação destes dados. Caso ainda não os tenha instalados, é só retirar o "\#" da frente e rodar as células

```{r}
#install.packages("dplyr")
#install.packages("readr")
#install.packages("here")
#install.packages("lubridate")
#install.packages("stringi")
#install.packages("data.table")
#install.packages("purrr")
#install.packages("tidyr")
#install.packages("readxl")
#install.packages("httr")
#install.packages("jsonlite")
#install.packages("stringr")
#install.packages("purrr")
#install.packages("readxl")
```

```{r, 'packages', warning=FALSE}
library(readr)
library(here)
library(dplyr)
library(lubridate)
library(data.table)
```

## 1.2 Base de Dados sobre Desastres

Os dados sobre a ocorrência de desastres foram levantados a partir do "Atlas Digital de Desastres no Brasil", publicado pelo Ministério de Integração e Desenvolvimento Regional do Brasil.

Eles podem ser baixados aqui: <http://atlasdigital.mdr.gov.br/paginas/downloads.xhtml>

A versão que utilizo é a publicada em 29 de abril de 2024, que inclui dados de 1991 a 2023

```{r, 'Baixando_desastres', warning=FALSE}
# Coloque a base de dados extraída do site do Atlas Digital de Desastres na pasta "Dados"
Desastres <- read_csv2(file = here("Dados/BD_Atlas_1991_2023_v1.0_2024.04.29.csv"), locale = locale(encoding = "Latin1")) #Baixa a base de dados de Desastres
```

```{r, 'Limpando_desastres'}

Desastres <- Desastres  %>% 
  select(Cod_IBGE_Mun,Nome_Municipio,Sigla_UF,regiao,Data_Evento,tipologia, descricao_tipologia, grupo_de_desastre, Status, DH_Descricao, DH_MORTOS, DH_DESAPARECIDOS, DH_total_danos_humanos, DM_Descricao, DM_total_danos_materiais) %>% #Seleciona as colunas de interesse
  rename("UF" = "Sigla_UF",
         "Desastre" = "descricao_tipologia",
         "Grupo_Desastre" = "grupo_de_desastre") %>% #Simplifica o nome de algumas colunas
     filter(!(Desastre %in% c('Doenças infecciosas','Rompimento/Colapso de barragens', 'Outros'))) %>%  #Remove as emergências que não são causadas diretamente por fatores climáticos
  mutate(Data = as.Date(Data_Evento, format = "%d/%m/%Y"),
                        "Mês" = month(`Data`), 
                        "Ano" = year(`Data`), #Atualiza colunas de tempo
           Municipio = tolower(Nome_Municipio)) %>% #Coloca todos os nomes de municipios em minúscula, para facilitar identificação com outras bases 
    mutate(Municipio = gsub(" ", "", Municipio), #Remove espaços no nome dos municípios, para facilitar identificação com outras bases
           Municipio_UF = paste(Municipio, UF, sep = "_")) #Cria um identificador único de nome do município e UF, para impedir a fusão de municípios homônimos

saveRDS(Desastres, file = here("Dados/Desastres.RDS")) #Salva a base de dados tratada na pasta Dados

rm(Desastres) #Limpa a base tratada, para economizar memória enquanto tratamos as demais
```

## 1.3 Dados de produção legislativa

Os dados de produção legislativa foram extraídos a partir das APIs abertas dos sites das câmaras municipais que utilizam o "Sistema de Apoio ao Processo Legislativo".

A lista de municípios participantes pode ser encontrada em: <https://www.senado.leg.br/senado/hotsites/interlegis/orgaos-atendidos.asp>

**O código para raspagem de dados dessa API está na pasta "Scraping", e deve ser rodado antes de utilizar este código.**

```{r, 'Dados_Camaras', warning=FALSE}
#Verifique que o documento com os dados raspados das Câmaras Municipais já está na pasta "Dados"
#ATENÇÃO: Este arquivo é muito pesado. Certifique-se de que seu computador tem memória para tratá-lo

CidadesAL <- read_csv(file= here("Dados/ProjCidades.csv")) 
```

```{r, 'Reduzindo_base'}
library(stringi)

#Removendo entradas duplicadas:
CidadesAL <- CidadesAL[!duplicated(CidadesAL[c('data_apresentacao', 'City', 'ementa')]),]

CidadesAL <- CidadesAL%>% 
  select(id, data_apresentacao, ano, City, numero, `__str__`, ementa, API_URL)%>% #selecionando colunas de interesse
  mutate(Data = as.Date(data_apresentacao), #Atualiza coluna para formato de Data
         Mês = month(Data), #Separa o mês
         Tipo_Projeto = tolower(sub(" nº.*", "", `__str__`)), #Separa o tipo de projeto
         Tipo = stri_trans_general(sub(" .*", "", `Tipo_Projeto`), "latin-ascii"),
         ementa = tolower(sub("\\*.*?\\*", "", ementa)), #Uniformiza as ementas
         UF = substring(gsub(".*\\.([^.]+)\\.[^.]+\\..*", "\\1", API_URL), 1, 2)) %>% #Separa a UF a partir do link
  group_by(City) %>%  #Agrupa dados por cidade, para que a base indique qual o primeiro ano com dados
  mutate(prim.ano = min(ano), #Separa o primeiro ano que o município tem um registro
         prim.data = min(Data), #Separa primeira data que o município tem um registro
         UF = toupper(UF),#Coloca UF em maiúscula
         Municipio_UF = stri_trans_general(paste(City, UF, sep = "_"), "Latin-ASCII")) %>% #Cria coluna com municipio e UF, para facilitar junção às outras bases
  rename("Nome_Propositura" = "__str__",
         "Municipio" = "City",
         "Ano" = "ano") %>% #Renomeia colunas
  ungroup()


```

Agora, irei adicionar à base um registro dos termos relacionados às políticas climáticas que serão utilizados na análise, para classificar os projetos a partir de suas ementas.

```{r, 'termos_clima'}
#Lista de termos relacionados às políticas climáticas
termos_clima <- c(" clima", " adaptação climática", " defesa civil", " alagamento",  " inundação", " inundações", " deslizamento", " aquecimento global", " mitigação", " chuva", " fortes chuvas", " vento", " deslizamento", " soterramento", " desabamento", " incêndio", " enxurrada", " eventos climáticos extremos"," seca", " estiagem", " estiagens" , " pluvial", " pluviais", " enchente", " chuvoso", " erosão", " descarbonização", " transição energética", " carbono", " efeito estufa")
  
# Criando coluna para inserir termos sobre clima
CidadesAL$clima_termos <- NA_character_

# Criando dummy sobre se o projeto é do Clima ou não
CidadesAL$projetoclima <- FALSE

# Loop checando se é um termo relacionado ao Clima.
for (termo in termos_clima) {
  # Checando se o termo aparece na Ementa
  termo_found <- grepl(termo, CidadesAL$ementa, ignore.case = TRUE)
  
  # Adicionando as respectivas colunas em "clima_termos"
  CidadesAL$clima_termos[termo_found] <- ifelse(is.na(CidadesAL$clima_termos[termo_found]), termo, paste(CidadesAL$clima_termos[termo_found], termo, sep = ", "))
  
  # Atualizando coluna "projetoclima
  CidadesAL$projetoclima <- CidadesAL$projetoclima | termo_found
}


rm(termo, termo_found, termos_clima) #Removendo lista de termos
```

Por fim, vamos salvar a base de Atividade Legislativa das Cidades

```{r, 'salvando_dados_projetos'}
#Base geral
CidadesAL <- CidadesAL %>% 
  select(id, Data, Ano, Municipio_UF, UF, Tipo, Tipo_Projeto, ementa, clima_termos,  Nome_Propositura, API_URL, prim.data, prim.ano, projetoclima)

#Salvando na pasta
saveRDS(CidadesAL, file = here("Dados/CidadesAL.RDS"))
```

## 1.4 Definindo o recorte temporal

Uma vez que já limpamos a base de dados de projetos, podemos definir o recorte temporal de análise.

Para utilizar um critério objetivo, será analisada a proporção de municípios presentes no SAPL que estão presentes em cada ano, o volume de produção legislativa em cada período, e a disponibilidade de dados.

```{r, 'Tabela_contagem_AL_tempo'}
CidadesAL <- CidadesAL %>% 
  data.table()

# Conferir que os tipos estão corretos.
CidadesAL[, Ano := as.integer(Ano)]
CidadesAL[, Cod_IBGE_Mun := as.character(Cod_IBGE_Mun)]

# 1. Get unique year-municipality combinations
municipios_por_ano <- unique(CidadesAL[, .(Ano, Cod_IBGE_Mun)])

# 2. Create lookup table: for each year, get municipios and join to later years
all_anos <- sort(unique(CidadesAL$Ano))

# 3. Initialize result list
result <- lapply(all_anos, function(ano) {
  # municípios in current year
  munis_i <- municipios_por_ano[Ano == ano, Cod_IBGE_Mun]

  # filter rows for year i and after, only for those municipalities
  after_rows <- CidadesAL[Ano >= ano & Cod_IBGE_Mun %in% munis_i]

  data.table(
    Ano = ano,
    n_municipios = length(unique(munis_i)),
    AL_Ano = nrow(CidadesAL[Ano == ano]),
    AL_pos_ano = nrow(after_rows)
  )
})

# Combine all rows into one data.table
df_contagem <- rbindlist(result)

rm(all_anos, municipios_por_ano, result)
```

```{r, 'plotando_contagem_tempo', warning = FALSE}

# Criar o gráfico
sapl_mun_years <- df_contagem %>% 
  filter(Ano >= 1991) %>% 
  ggplot(aes(x = Ano)) +
  # Adicionar o gráfico de barras para "n_municipios"
  geom_bar(aes(y = n_municipios), stat = "identity", fill = "#1B9E77") +
  # Adicionar o gráfico de linha para "AL_pos_ano"
  geom_line(aes(y = AL_pos_ano * (max(df_contagem$n_municipios) / max(df_contagem$AL_pos_ano)))) +
  geom_vline(xintercept = 2013, linetype = "dashed")+
  # Adicionar eixos duplos
  scale_y_continuous(
    name = "Número de Municípios",
    sec.axis = sec_axis(~ . * (max(df_contagem$AL_pos_ano) / max(df_contagem$n_municipios)), name = "Registros nos anos subsequentes (até 2025)",
      breaks = scales::pretty_breaks(),
      labels = scales::comma_format(big.mark = ".", decimal.mark = ","))
  ) +
  scale_x_continuous(n.breaks = 10)+
  # Personalizar cores e temas
  theme_linedraw()+
  labs(title = "Nº de municípios na base de dados por ano x Total de proposituras nos anos subsequentes")+
  theme(title = element_text(size = 9),
        axis.text.y.left = element_text(color = "#1B9E77", size = 10),   # Cor do texto do eixo Y à esquerda
        axis.title.y.left = element_text(color = "#1B9E77"))   # Cor do título do eixo Y à esquerda




ggsave(here("Figuras/2. SAPL recorte temporal.png"), sapl_mun_years)

# Exibir o gráfico
print(sapl_mun_years)

```

```{r}
rm(df_contagem, sapl_mun_years)
```

A partir desta análise, foi escolhido o período de 2013 a 2023 como ponto de corte. Podemos salvar a lista de municípios presentes a partir deste ano com o seguinte código:

```{r}
#Selecionando só os municípios presentes em todo o período selecionado
CidadesAL13_23 <- CidadesAL %>% 
  filter(as.Date("2013-01-01") < prim.data,
         Data < as.Date("2023-12-31")) %>% 
  data.table()

saveRDS(CidadesAL13_23, here("Dados/CidadesAL13_23.RDS"))

```

## 1.5 Salvando base só com projetos climáticos

A seguir, filtraremos apenas os projetos em que foram identificados como tendo termos associados às políticas climáticas.

Primeiro, criamos uma contagem do número total de projetos no dia em cada município, para não perdermos esta informação

```{r, 'dados_so_clima'}

#Adicionando total de projetos por dia, por tipo de projeto, por cidade

##Criando segunda base de dados sumarizando número de projetos por dia
#Só por projeto e data:
#CidadesAL_13_23 <- readRDS(here("Dados/CidadesAL_13_23.RDS"))

nproj_data <- CidadesAL13_23 %>% 
  group_by(Data, Municipio_UF, Tipo_Projeto) %>% 
  summarise(total_tipo_proj_dia = n(), .groups = "drop") %>% 
  data.table() 

# Para evitar contar dias em que as câmaras estão fechadas, criamos a variável "Dia" para levar em conta apenas dias em que elas estão abertas

lista_municipios_datas <- nproj_data[, .(Data = unique(Data)), by = Municipio_UF]

setorder(lista_municipios_datas, Municipio_UF, Data)

lista_municipios_datas[, Dia := seq_len(.N), by = Municipio_UF]

# Step 2: Join lista_municipios_datas back to nproj_data
nproj_data <- merge(nproj_data, lista_municipios_datas, by = c("Municipio_UF", "Data"), all.x = TRUE)

saveRDS(lista_municipios_datas, here("Dados/lista_municipios_datas.RDS"))

rm(lista_municipios_datas)
```

```{r}

#Base só com projetos de Clima
CidadesAL13_23 <- CidadesAL13_23 %>% 
  filter(projetoclima == T)

#Juntando as informações
ALClima13_23 <- merge(CidadesAL13_23, nproj_data, by = c("Data", "Municipio_UF", "Tipo_Projeto"), all.x  = T)

#Salvando (com um NOME DIFERENTE) a base com dados só de clima:
saveRDS(ALClima13_23, file = here("Dados/ALClima13_23.RDS"))

rm(nproj_data, CidadesAL13_23) #Removendo baseS temporária
```

## 1.6 Adicionando mais informações dos municípios

### Criando lista de municípios

Agora, iremos adicionar algumas informações da base de desastres à base de atividade legislativa.

Primeiro, fazemos uma lista de municípios que estão em ambas as bases, com informações como o código IBGE:

```{r, 'fazendo_lista_municipios'}
## CidadesAL
#Trazendo de volta a base de Desastres
Desastres <- readRDS(file = here("Dados/Desastres.RDS")) #Recupera a base de Desastres

#Adiciona informações na lista de municípios
lista_municipios <-  Desastres %>% 
  select(Cod_IBGE_Mun, Nome_Municipio, UF, Municipio_UF) %>% 
  unique() %>% 
  data.frame()

```

```{r}
#Adiciona informações da lista de municípios em CidadesAL
CidadesAL <- merge(CidadesAL, lista_municipios, by = c("UF", "Municipio_UF"), all.x = TRUE)

#Salvando CidadesAL atualizado:
saveRDS(CidadesAL, file = here("Dados/CidadesAL.RDS"))

#Filtra na lista de desastres os municípios presentes nas bases do SAPL
Desastres <- Desastres %>% 
  filter(Municipio_UF %in% ALClima13_23$Municipio_UF)

saveRDS(Desastres, here("Dados/Desastres13_23.RDS"))

rm( CidadesAL, Desastres )
```

```{r}

#ALClima

# Adiciona informações de lista municípios à ALClima
ALClima13_23 <- merge(ALClima13_23, lista_municipios, by = c("UF", "Municipio_UF"), all.x = TRUE)

saveRDS(ALClima13_23, here("Dados/ALClima13_23.RDS")) #Salva a lista de municípios

rm(lista_municipios, ALClima13_23)

```

## 1.7 Adicionando informações municipais de outras fontes

Agora que já temos uma base de dados com todas as informações, incluindo os códigos do IBGE dos municípios, podemos adicionar outras informações que serão utilizadas como controle na nossa análise.

### 1.7.1 Níveis de Risco Climático

Uma importante variável de controle é o de nível de risco climático. Espera-se que a agenda em políticas de adaptação climática seja menor nos municípios que não estão diretamente vulneráveis aos efeitos das mudanças climáticas, e nos que já adotaram medidas de adaptação que dão conta de sua demanda.

O "Sistema Adapta Brasil", produzido pelo Ministério de Ciência e Tecnologia, produz índices dos graus de adaptação dos municípios às mudanças climáticas a partir de uma série de indicadores : [https://sistema.adaptabrasil.mcti.gov.br/https://sistema.adaptabrasil.mcti.gov.br/](https://sistema.adaptabrasil.mcti.gov.br/){.uri}

Iremos importar essa base para todos os municípios, incluindo dados segmentados sobre Vulnerabilidades, Nível de Ameaça Climática, Sensibilidade e Nível de Adaptação.

```{r}
#Importando os pacotes necessários:
library(httr)
library(jsonlite)
library(stringr)
library(purrr)
```

Primeiro, certifique-se de baixar e deixar o arquivo "adaptaBrasilAPIEstrutura.csv" dentro da pasta "Dados". Ela pode ser produzida ou baixada no Github oficial do projeto AdaptaBrasil: <https://github.com/AdaptaBrasil/AdaptaBrasilAPIAccess?tab=readme-ov-file>

```{r}
#Subindo e limpando a base de links (disponível em: https://github.com/AdaptaBrasil/AdaptaBrasilAPIAccess?tab=readme-ov-file )
AdaptaBrasil <- read.csv(here("Dados/adaptaBrasilAPIEstrutura.csv"), sep = "|") %>% 
  filter(nivel %in% c(2:4),
        setor_estrategico %in% c("Recursos Hídricos", "Segurança Alimentar", "Desastres Hidrológicos"))


```

```{r}
# Lista para armazenar os data.frames resultantes
AdaptaBrasilInd <- list()

# Função auxiliar para gerar nome único para cada dataframe
gerar_nome_df <- function(setor, nivel, nome) {
  nome_limpo <- str_replace_all(paste(nivel, setor, nome, sep = "_"), "\\s+", "_")
  nome_limpo <- str_replace_all(nome_limpo, "[^[:alnum:]_]", "") # remove caracteres especiais
  return(nome_limpo)
}

# Loop por cada linha do dataframe filtrado
for (i in seq_len(nrow(AdaptaBrasil))) {
  
  # Extrai a URL e campos de nomeação
  url <- AdaptaBrasil$url_obtem_dados_indicador[i]
  setor <- AdaptaBrasil$setor_estrategico[i]
  nivel <- AdaptaBrasil$nivel[i]
  nome <- AdaptaBrasil$nome[i]
  
  # Gera nome da lista/dataframe
  nome_df <- gerar_nome_df(setor, nivel, nome)
  
  # Tenta fazer a requisição GET e tratar a resposta
  try({
    resposta <- GET(url)
    if (status_code(resposta) == 200) {
      conteudo_json <- content(resposta, "text", encoding = "UTF-8")
      dados <- fromJSON(conteudo_json, flatten = TRUE)
      
      # Converte para dataframe (caso necessário)
      if (is.data.frame(dados)) {
        AdaptaBrasilInd[[nome_df]] <- dados
      } else if (is.list(dados)) {
        AdaptaBrasilInd[[nome_df]] <- as.data.frame(dados)
      }
    } else {
      message(sprintf("Falha na URL %s - Código: %d", url, status_code(resposta)))
    }
  }, silent = TRUE)
}

rm(conteudo_json, dados, gerar_nome_df, i, nivel, nome, nome_df, resposta, setor, url)
```

```{r}
# Adiciona uma coluna "indicador_origem" com o nome da lista para identificar a origem de cada dataframe
AdaptaBrasil <- imap(AdaptaBrasilInd, ~ mutate(.x, indicador_origem = .y))

# Junta todos os dataframes em um único dataframe
AdaptaBrasil <- bind_rows(AdaptaBrasil) %>% 
  filter(pessimist == 1) %>% 
  rename(Cod_IBGE_Mun = geocod_ibge) %>% 
  mutate(Municipio_UF = str_replace(name, "/", "_"),
         label = paste0("label_", indicador_origem)) %>% 
  select(Cod_IBGE_Mun, Municipio_UF, value, indicador_origem) %>%  
  pivot_wider(names_from = indicador_origem, values_from = value, names_prefix = "AB_") %>% 
  data.table()

saveRDS(AdaptaBrasil, here("Dados/AdaptaBrasil.RDS"))

rm(AdaptaBrasilInd, AdaptaBrasil)
```

### 1.7.2 Grupos de Interesse (OSCs, Associações, ONGs, etc)

Um dos elementos presentes em toda a literatura a respeito da produção de política climáticas é o papel de organizações da sociedade civil em pressionar os agentes públicos, ajudando a colocar a pauta climática na agenda.

No Brasil, essas organizações inscrevem seus CNPJs como "Organizações da Sociedade Civil" (OSCs). O IPEA disponibiliza o levantamento de todas essas organizações na plataforma "Mapa das OSCs". Iremos levantar e tratar esses dados para utilizar na análise:

Fonte dos dados: <https://mapaosc.ipea.gov.br/base-dados>

Certifique-se que estão na pasta "Dados" os arquivos:

-   base_OSC_agosto_2023.csv

-   area_subarea.xlsx

```{r}
#Baixando a base
OSCs <- read_csv2(here("Dados/base_OSC_agosto_2023.csv"))

#Selecionando só as colunas de interesse

OSCs <- OSCs %>% 
  select(!c(tx_nome_fantasia_osc, cd_natureza_juridica_osc, tx_endereco_completo, cd_uf, tx_latitude, tx_longitude, cn %>% ae, cnae_fiscal_secundaria)) %>% 
  pivot_longer(cols = starts_with("Area_"), names_prefix = "Area_", names_to = "Area", values_to = "Value") %>% 
  filter(Value == 1) %>% 
  pivot_longer(cols = starts_with("SubArea_"), names_prefix = "SubArea_", names_to = "Subarea", values_to = "ValueSub") %>% 
  filter(ValueSub == 1) %>% 
  rename("Cod_IBGE_Mun" = cd_municipio) %>% 
    select(!c(Value, ValueSub))
```

```{r}

#Adicionando áreas
#library(readxl) #pacote necessário

#Adiciona a tabela com subáreas:
OSC_Area <- read_xlsx(here("Dados/area_subarea.xlsx"))

#Seleciona as colunas de interesse:
OSC_Area <- OSC_Area %>% 
  select(!c(id_osc...1, tx_razao_social_osc, tx_nome_fantasia_osc, dt_fundacao_osc, cd_natureza_juridica_osc, edmu_cd_municipio, edmu_nm_municipio, eduf_cd_uf, eduf_sg_uf, id_osc...12, id_osc...24, `HabitaÃ§Ã£o`, `SaÃºde`,	`Cultura e recreaÃ§Ã£o`, `EducaÃ§Ã£o e pesquisa`,	`AssistÃªncia social`,	`ReligiÃ£o`, 	`AssociaÃ§Ãµes patronais, profissionais e de produtores rurais`, 	`Meio ambiente e proteÃ§Ã£o animal`, 	`Desenvolvimento e defesa de direitos`,	`Outros`,	`Outras atividades associativas`)) %>% 
  rename(cnpj = cd_identificador_osc) %>% 
  pivot_longer(cols = c(3:46), names_to = "Subarea2", values_to = "Value") %>% 
  filter(Value == 1) %>% 
  select(!Value) %>%
  mutate(across(where(is.character), ~ iconv(., from = "UTF-8", to = "latin1")))
```

```{r}
#Juntando as duas

OSCs <- merge(OSCs, OSC_Area, by = c("cnpj"), all.x = T) %>% 
  mutate(Subarea2 = ifelse(is.na(Subarea2), Subarea, Subarea2))

rm(OSC_Area)

saveRDS(OSCs, here("Dados/OSCsLista.RDS")) 
```

```{r}
#Limpando termos de OSCs que dizem pouco a respeito da agenda climática:

OSCs <- readRDS(here("Dados/OSCsLista.RDS")) 

lista_municipios <- readRDS("Dados/lista_municipios.RDS")

OSCs <- OSCs %>% 
  filter(Cod_IBGE_Mun %in% lista_municipios$Cod_IBGE_Mun) %>% 
  filter(!Area %in%  c("Religiao", "Cultura_e_recreacao"), 
         !Subarea %in% c("Educacao_infantil", "Ensino_fundamental", "Ensino_superior", "Hospitais", "Religiao", "Educacao_profissional", "Cultura_e_arte", "Esportes_e_recreacao"),
         !Subarea2 %in% c("Cultura sub Cultura e arte", "Religiao sub Outros", "	
Desenv e Def sub Religião", "Educacao sub Educação superior", "	
Saude sub Hospitais", "Educacao sub Ensino médio", "Cultura sub Outros"), 
         !tx_nome_classe_atividade_economica %in% c("tx_nome_classe_atividade_economica", "Atividades de assistência psicossocial e à saúde a portadores de distúrbios psíquicos, deficiência mental e dependência química", "Ensino de esportes", "Atividades de atenção ambulatorial executadas por médicos e odontólogos", "Ensino de arte e cultura", "Atividades de serviços de complementação diagnóstica e terapêutica", "Atividades de organizações religiosas", "Ensino de idiomas", "Artes cênicas, espetáculos e atividades complementares", "Ensino fundamental", "Educação infantil - creche", "Atividades de rádio", "Educação superior - graduação e pós-graduação", "Clubes sociais, esportivos e similares", "Educação superior - graduação", "Atividades de atendimento hospitalar", "	
Educação infantil - pré-escola", "	
Educação profissional de nível técnico", "	
Planos de saúde", "	
Atividades de museus e de exploração, restauração artística e conservação de lugares e prédios históricos e atrações similares", "	
Comércio varejista de livros, jornais, revistas e papelaria", "Criação artística", "Serviços de remoção de pacientes, exceto os serviços móveis de atendimento a urgências", "Atividades de televisão aberta", "Comércio atacadista de resíduos e sucatas", "Atividades de produção cinematográfica, de vídeos e de programas de televisão", "Atividades de bibliotecas e arquivos", "Comércio atacadista de produtos alimentícios em geral", "Comércio varejista de outros produtos novos não especificados anteriormente", "Educação profissional de nível tecnológico", "Atividades de exibição cinematográfica", "Ensino médio", "Atividades de contabilidade, consultoria e auditoria contábil e tributária", "Edição de livros", "Fotocópias, preparação de documentos e outros serviços especializados de apoio administrativo", "Programadoras e atividades relacionadas à televisão por assinatura", "Restaurantes e outros estabelecimentos de serviços de alimentação e bebidas", "Comércio atacadista de cereais e leguminosas beneficiados, farinhas, amidos e féculas", "Comércio varejista de produtos farmacêuticos para uso humano e veterinário", "Transporte rodoviário coletivo de passageiros, com itinerário fixo, municipal e em região metropolitana", "Transporte rodoviário coletivo de passageiros, sob regime de fretamento, e outros transportes rodoviários não especificados anteriormente", "Atividades de gravação de som e de edição de música", "Comércio varejista de artigos médicos e ortopédicos", "Comércio varejista de artigos recreativos e esportivos", "Comércio varejista de produtos alimentícios em geral ou especializado em produtos alimentícios não especificados anteriormente; produtos do fumo", "Comércio varejista de produtos de padaria, laticínio, doces, balas e semelhantes", "Desenvolvimento de programas de computador sob encomenda", "Edição integrada à impressão de livros", "Estacionamento de veículos", "Hotéis e similares", "Portais, provedores de conteúdo e outros serviços de informação na internet", "Transporte escolar", "Atividades de exploração de jogos de azar e apostas", "Educação infantil - pré-escola", "Transporte rodoviário de táxi", "Edição integrada à impressão de revistas", "Serviços de pré-impressão"))

```

```{r}

library(tidyr)
#Sumarizando:
OSCsClima <- OSCs %>% 
  group_by(Cod_IBGE_Mun, dt_fundacao_osc) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = "Cod_IBGE_Mun", values_from = n) %>%
  arrange(dt_fundacao_osc) %>% 
  as.data.table()

# Removendo NAs:
cols <- setdiff(names(OSCsClima), "dt_fundacao_osc")
OSCsClima[, (cols) := lapply(.SD, function(x) fifelse(is.na(x), 0L, x)), .SDcols = cols]

# Calculando cumulativo de OSCs por cidade
OSCsClima[, (cols) := lapply(.SD, cumsum), .SDcols = cols]

# Pivot Longer para Coluna "Cod_IBGE_Mun"
OSCsClima <- OSCsClima %>% 
  melt(id.vars = "dt_fundacao_osc", # Mantém data inalterada
  variable.name = "Cod_IBGE_Mun",   # Transfere as demais colunas para "Cod_IBGE_Mun"
  value.name = "n_OSCs"         # Transfere os valores para n_OSCs
)

#Separando só datas a partir de 1991
OSCsClima <- OSCsClima[dt_fundacao_osc >= as.Date("1991-01-01"), ]

saveRDS(OSCsClima, here("Dados/OSCsClima.RDS"))

rm(OSCs, OSCsClima, lista_municipios, cols)
```

### 1.7.3 Orçamento Municipal

Outra variável importante levantada na bibliografia é a disponibilidade de recursos. Usamos as receitas orçamentárias municipais como proxy para essa variável.

As receitas orçamentárias anuais estão disponíveis no site do "Sistema de Informações Contabéis e Fiscais do Setor Público Brasileiro - SICONFI", a partir da prestação de contas anuais: <https://siconfi.tesouro.gov.br/siconfi/pages/public/consulta_finbra/finbra_list.jsf>

Para facilitar a leitura, o Senado Federal, através do "Panorama do Legislativo Municipal", compila os dados dos orçamentos municipais já tratados **entre 2013 e 2021**

Dados: <https://www.senado.leg.br/institucional/datasenado/panorama/#/dados>

```{r}
orcamento <- read.csv2(here("Dados/orcamentodomunicipio.csv"), encoding = "UTF-8")

#Permite visualizar corretamento os caracteres:
orcamento[] <- lapply(orcamento, function(x) {
  if (is.character(x)) iconv(x, from = "Latin1", to = "UTF-8") else x
})

#Dados do orçamento municipal
orcamento <- orcamento %>% 
  select(!Porcentagem) %>% 
  filter(Categoria == "Receitas realizadas") %>% 
  pivot_wider(names_from = Categoria,
              values_from = Valor, 
              names_prefix = "Orcamento_Mun ") %>% 
  rename("Cod_IBGE_Mun" = "Cod.IBGE", 
         "Receitas_Mun" = "Orcamento_Mun Receitas realizadas")
```

E agora, adicionando os dados de 2022 e 2023:

```{r}
#Orçamento 2022
orcamento2022 <- read.csv2(here("Dados/finbra2022.csv"), skip = 3, sep = ";", encoding = "latin1")

orcamento2022 <- orcamento2022 %>% 
  filter(Conta == "RECEITAS (EXCETO INTRA-ORÇAMENTÁRIAS) (I)", 
         Coluna == "Receitas Brutas Realizadas") %>% 
  rename(Cod_IBGE_Mun = Cod.IBGE, 
         "Receitas_Mun" = Valor) %>% 
  mutate(Ano = 2022) %>% 
  select(Cod_IBGE_Mun, Ano, Receitas_Mun)

#Orçamento 2023

orcamento2023 <- read.csv2(here("Dados/finbra2023.csv"), skip = 3, sep = ";", encoding = "latin1")

orcamento2023 <- orcamento2023 %>% 
  filter(Conta == "RECEITAS (EXCETO INTRA-ORÇAMENTÁRIAS) (I)", 
         Coluna == "Receitas Brutas Realizadas") %>% 
  rename(Cod_IBGE_Mun = Cod.IBGE, 
         "Receitas_Mun" = Valor) %>% 
  mutate(Ano = 2023) %>% 
  select(Cod_IBGE_Mun, Ano, Receitas_Mun)

orcamento <- bind_rows(orcamento, orcamento2022)

orcamento <- bind_rows(orcamento, orcamento2023)

saveRDS(orcamento, here("Dados/orcamento2013_2023.RDS"))

rm(orcamento, orcamento2022, orcamento2023)
```

### 1.7.4 - Datas eleições TSE

Por fim, outra variável relevante é a proximidade de eleições. Elas afetam o comportamento dos políticos e podem alterar o comportamento legislativo. Vamos criar uma base com as datas dos 1ºturnos das eleições municipais no período analisado, extraída do calendário do TSE: <https://www.tse.jus.br/eleicoes/eleicoes-anteriores?tab=ancora-3>

<https://www.tse.jus.br/eleicoes/calendario-eleitoral/calendario-eleitoral>

```{r}
eleicoes <- data.frame("eleicoes" = c("1992-10-03", "1996-10-03", "2000-10-01", "2004-10-03", "2008-10-05", "2012-10-07", "2016-10-02", "2020-11-15", "2024-10-06"))

saveRDS(eleicoes, here("Dados/eleicoes.RDS"))

rm(eleicoes)
```

## 1.8 Juntando as bases de dados

Agora, vamos juntar todas as bases de dados.

### ALClima + AdaptaBrasil

Vamos começar adicionando as informações do AdaptaBrasil à nossa base de ALClima para os anos analisados

```{r}
#Recuperando as bases de dados:
ALClima13_23 <- readRDS(here("Dados/ALClima13_23.RDS"))

AdaptaBrasil <- readRDS(here("Dados/AdaptaBrasil.RDS"))

#Verificando quais códigos IBGE faltam em "ALClima13_23"

na_ibge <-  ALClima13_23 %>% 
  filter(is.na(Cod_IBGE_Mun)) %>% 
  select(Municipio_UF)

#Juntando as duas bases
df <- merge(df, AdaptaBrasil, by = c("Cod_IBGE_Mun"), all = T)

rm(AdaptaBrasil)
```

### Adicionando dias desde o último desastre.

Primeiro, adicionamos a informação sobre a distância entre a data do desastres mais recente (ou do desastre seguinte) em relação à apresentação do projeto. Esta informação irá ajudar a compreender melhor o contexto em que um projeto foi apresentado

```{r, 'dias_ultimo_desastre'}


# 1. Criando base de dados alinhando combinações de projetos e deastres que aconteceram antes deles
ALClima_prev <- ALClima13_23 %>%
  left_join(Desastres, by = "Municipio_UF", suffix = c("", "_desastre")) %>% #Cria todas as combinações de projetos e desastres por município
  filter(Data_desastre < Data) %>% #Filtra só as linhas em que a data do desastre antecede a data do projeto
  group_by(UF, Municipio_UF, Cod_IBGE_Mun, Data) %>% #Agrupa pelas informações de município e data  
  slice_max(Data_desastre, with_ties = FALSE) %>% #mantêm apenas a primeira versão de cada combinação em cada cidade
  ungroup() %>%
  select(UF, Municipio_UF, Cod_IBGE_Mun, Data, data_desastre_anterior = Data_desastre, desastre_anterior = Desastre) #Seleciona as colunas que serão integradas depois, renomeando as novas

#Repete o anterior, mas para o desastre seguinte
ALClima_next <- ALClima13_23 %>%
  left_join(Desastres, by = "Municipio_UF", suffix = c("", "_desastre")) %>%
  filter(Data_desastre >= Data) %>%
  group_by(UF, Municipio_UF, Cod_IBGE_Mun, Data) %>%
  slice_min(Data_desastre, with_ties = FALSE) %>%
  ungroup() %>%
  select(UF, Municipio_UF, Cod_IBGE_Mun, Data, data_desastre_proximo = Data_desastre, desastre_proximo = Desastre)

#Junta os arquivos na base original:
ALClima13_23 <- ALClima13_23 %>%
  left_join(ALClima_prev, by = c("UF", "Municipio_UF", "Cod_IBGE_Mun", "Data")) %>%
  left_join(ALClima_next, by = c("UF", "Municipio_UF", "Cod_IBGE_Mun", "Data")) %>%
  mutate(
    dias_desastre_anterior = as.integer(Data - data_desastre_anterior),
    dias_desastre_proximo = as.integer(Data - data_desastre_proximo)
  )

#Salva a versão atualizada da base
saveRDS(ALClima13_23, file = here("Dados/ALClima13_23.RDS"))

# Remove os objetos que não serão mais utilizados
rm(ALClima_prev, ALClima_next, lista_municipios, Desastres, ALClima13_23)

```

### ALClima

```{r}
library(tidyr)



#Criando base para juntar informações
df <- expand_grid(
  Cod_IBGE_Mun = unique(ALClima$Cod_IBGE_Mun),
  Data = seq(as.Date("2013-01-01"), as.Date("2023-12-31"), by = "day")
)%>% 
  data.table()

#Juntando base ALClima a essa

df <- merge(df, ALClima, by = c("Cod_IBGE_Mun", "Data"), all = T) %>% 
  mutate(Cod_IBGE_Mun = as.character(Cod_IBGE_Mun)) %>% 
  filter(!is.na(Cod_IBGE_Mun))

rm(ALClima)
```

### Orçamento Municipal

```{r}
orcamento <- readRDS(here("Dados/orcamento2013_2023.RDS"))


```

### Eleições

```{r}
eleicoes <- readRDS(here("Dados/eleicoes.RDS"))
```

### OSCs

```{r}
OSCsClima <- readRDS(here("Dados/OSCsClima.RDS")) %>% 
  rename("Data" = dt_fundacao_osc) %>% 
  filter(Cod_IBGE_Mun %in% unique(df$Cod_IBGE_Mun), 
         Data  %in% unique(df$Data)) %>% 
  data.table()


df <- merge(df, OSCsClima, by = c("Cod_IBGE_Mun", "Data"), all = T)
```

```{r}





```

orcamento \<- readRDS(here("Dados/orcamento2013_2023.RDS"))
