---
title: "1. Carregando e limpando as bases de dados"
output: html_document
---

**Atenção**: Não esqueça de rodar antes o arquivo "0"

# 1. Carregando e limpando as bases de dados

## 1.1 Importando pacotes

Antes de começar, estes são os pacotes que serão necessários para manipulação destes dados. Caso ainda não os tenha instalados, é só retirar o "\#" da frente e rodar as células

```{r}
#install.packages("dplyr")
#install.packages("readr")
#install.packages("here")
#install.packages("lubridate")
#install.packages("stringi")
#install.packages("data.table")
#install.packages("purrr")
#install.packages("tidyr")
```

```{r, 'packages', echo=FALSE}
library(readr)
library(here)
library(dplyr)
library(lubridate)
library(data.table)
```

## 1.2 Base de Dados sobre Desastres

Os dados sobre a ocorrência de desastres foram levantados a partir do "Atlas Digital de Desastres no Brasil", publicado pelo Ministério de Integração e Desenvolvimento Regional do Brasil.

Eles podem ser baixados aqui: <http://atlasdigital.mdr.gov.br/paginas/downloads.xhtml>

A versão que utilizo é a publicada em 29 de abril de 2024, que inclui dados de 1991 a 2023

```{r, 'Baixando_desastres', warning=FALSE}
# Coloque a base de dados extraída do site do Atlas Digital de Desastres na pasta "Dados"
Desastres <- read_csv2(file = here("Dados/BD_Atlas_1991_2023_v1.0_2024.04.29.csv"), locale = locale(encoding = "Latin1")) #Baixa a base de dados de Desastres
```

```{r, 'Limpando_desastres'}

Desastres <- Desastres  %>% 
  select(Cod_IBGE_Mun,Nome_Municipio,Sigla_UF,regiao,Data_Evento,tipologia, descricao_tipologia, grupo_de_desastre, Status, DH_Descricao, DH_MORTOS, DH_DESAPARECIDOS, DH_total_danos_humanos, DM_Descricao, DM_total_danos_materiais) %>% #Seleciona as colunas de interesse
  rename("UF" = "Sigla_UF",
         "Desastre" = "descricao_tipologia",
         "Grupo_Desastre" = "grupo_de_desastre") %>% #Simplifica o nome de algumas colunas
     filter(!(Desastre %in% c('Doenças infecciosas','Rompimento/Colapso de barragens', 'Outros'))) %>%  #Remove as emergências que não são causadas diretamente por fatores climáticos
  mutate(Data = as.Date(Data_Evento, format = "%d/%m/%Y"),
                        "Mês" = month(`Data`), 
                        "Ano" = year(`Data`), #Atualiza colunas de tempo
           Municipio = tolower(Nome_Municipio)) %>% #Coloca todos os nomes de municipios em minúscula, para facilitar identificação com outras bases 
    mutate(Municipio = gsub(" ", "", Municipio), #Remove espaços no nome dos municípios, para facilitar identificação com outras bases
           Municipio_UF = paste(Municipio, UF, sep = "_")) #Cria um identificador único de nome do município e UF, para impedir a fusão de municípios homônimos

saveRDS(Desastres, file = here("Dados/Desastres.RDS")) #Salva a base de dados tratada na pasta Dados

rm(Desastres) #Limpa a base tratada, para economizar memória enquanto tratamos as demais
```

## 1.3 Dados de produção legislativa

Os dados de produção legislativa foram extraídos a partir das APIs abertas dos sites das câmaras municipais que utilizam o "Sistema de Apoio ao Processo Legislativo".

A lista de municípios participantes pode ser encontrada em: <https://www.senado.leg.br/senado/hotsites/interlegis/orgaos-atendidos.asp>

**O código para raspagem de dados dessa API está na pasta "Scraping", e deve ser rodado antes de utilizar este código.**

```{r, 'Dados_Camaras', warning=FALSE}
#Verifique que o documento com os dados raspados das Câmaras Municipais já está na pasta "Dados"
#ATENÇÃO: Este arquivo é muito pesado. Certifique-se de que seu computador tem memória para tratá-lo

CidadesAL <- read_csv(file= here("Dados/ProjCidades.csv")) 
```

```{r, 'Reduzindo_base'}
library(stringi)

#Removendo entradas duplicadas:
CidadesAL <- CidadesAL[!duplicated(CidadesAL[c('data_apresentacao', 'City', 'ementa')]),]

CidadesAL <- CidadesAL%>% 
  select(id, data_apresentacao, ano, City, numero, `__str__`, ementa, API_URL)%>% #selecionando colunas de interesse
  mutate(Data = as.Date(data_apresentacao), #Atualiza coluna para formato de Data
         Mês = month(Data), #Separa o mês
         Tipo_Projeto = tolower(sub(" nº.*", "", `__str__`)), #Separa o tipo de projeto
         Tipo = stri_trans_general(sub(" .*", "", `Tipo_Projeto`), "latin-ascii"),
         ementa = tolower(sub("\\*.*?\\*", "", ementa)), #Uniformiza as ementas
         UF = substring(gsub(".*\\.([^.]+)\\.[^.]+\\..*", "\\1", API_URL), 1, 2)) %>% #Separa a UF a partir do link
  group_by(City) %>%  #Agrupa dados por cidade, para que a base indique qual o primeiro ano com dados
  mutate(prim.ano = min(ano), #Separa o primeiro ano que o município tem um registro
         prim.data = min(Data), #Separa primeira data que o município tem um registro
         UF = toupper(UF),#Coloca UF em maiúscula
         Municipio_UF = stri_trans_general(paste(City, UF, sep = "_"), "Latin-ASCII")) %>% #Cria coluna com municipio e UF, para facilitar junção às outras bases
  rename("Nome_Propositura" = "__str__",
         "Municipio" = "City",
         "Ano" = "ano") %>% #Renomeia colunas
  ungroup()


```

Agora, irei adicionar à base um registro dos termos relacionados às políticas climáticas que serão utilizados na análise, para classificar os projetos a partir de suas ementas.

```{r, 'termos_clima'}
#Lista de termos relacionados às políticas climáticas
termos_clima <- c(" clima", " adaptação climática", " defesa civil", " alagamento",  " inundação", " inundações", " deslizamento", " aquecimento global", " mitigação", " chuva", " fortes chuvas", " vento", " deslizamento", " soterramento", " desabamento", " incêndio", " enxurrada", " eventos climáticos extremos"," seca", " estiagem", " estiagens" , " pluvial", " pluviais", " enchente", " chuvoso", " erosão", " descarbonização", " transição energética", " carbono", " efeito estufa")
  
# Criando coluna para inserir termos sobre clima
CidadesAL$clima_termos <- NA_character_

# Criando dummy sobre se o projeto é do Clima ou não
CidadesAL$projetoclima <- FALSE

# Loop checando se é um termo relacionado ao Clima.
for (termo in termos_clima) {
  # Checando se o termo aparece na Ementa
  termo_found <- grepl(termo, CidadesAL$ementa, ignore.case = TRUE)
  
  # Adicionando as respectivas colunas em "clima_termos"
  CidadesAL$clima_termos[termo_found] <- ifelse(is.na(CidadesAL$clima_termos[termo_found]), termo, paste(CidadesAL$clima_termos[termo_found], termo, sep = ", "))
  
  # Atualizando coluna "projetoclima
  CidadesAL$projetoclima <- CidadesAL$projetoclima | termo_found
}


rm(termo, termo_found, termos_clima) #Removendo lista de termos
```

Por fim, vamos salvar a base de Atividade Legislativa das Cidades

```{r, 'salvando_dados_projetos'}
#Base geral
CidadesAL <- CidadesAL %>% 
  select(id, Data, Ano, Municipio_UF, UF, Tipo, Tipo_Projeto, ementa, clima_termos,  Nome_Propositura, API_URL, prim.data, prim.ano, projetoclima)

#Salvando na pasta
saveRDS(CidadesAL, file = here("Dados/CidadesAL.RDS"))
```

## 1.4 Salvando base só com projetos climáticos

A seguir, filtraremos apenas os projetos em que foram identificados como tendo termos associados às políticas climáticas.

Primeiro, criamos uma contagem do número total de projetos no dia em cada município, para não perdermos esta informação

```{r, 'dados_so_clima'}
#Adicionando total de projetos por dia, por tipo de projeto, por cidade

##Criando segunda base de dados sumarizando número de projetos por dia
#Só por projeto e data:

nproj_data <- CidadesAL %>% 
  group_by(Data, Municipio_UF, Tipo) %>% 
  summarise(total_proj_dia = n())
  data.frame()

#Base só com projetos de Clima
CidadesAL <- CidadesAL %>% 
  filter(projetoclima == T)

#Juntando as informações
ALClima <- merge(CidadesAL, nproj_data, by = c("Data", "Municipio_UF", "Tipo"), all.x = T)

#Salvando (com um NOME DIFERENTE) a base com dados só de clima:
saveRDS(ALClima, file = here("Dados/ALClima.RDS"))

rm(nproj_data) #Removendo base temporária
```

## 1.5 Adicionando mais informações dos municípios

### Criando lista de municípios

Agora, iremos adicionar algumas informações da base de desastres à base de atividade legislativa.

Primeiro, fazemos uma lista de municípios que estão em ambas as bases, com informações como o código IBGE:

```{r, 'fazendo_lista_municipios'}
## CidadesAL
#Trazendo de volta a base de Desastres
DesastresSAPL <- readRDS(file = here("Dados/Desastres.RDS")) #Recupera a base de Desastres

#Adiciona informações na lista de municípios
lista_municipios <-  DesastresSAPL %>% 
  select(Cod_IBGE_Mun, Nome_Municipio, UF, Municipio_UF) %>% 
  unique() %>% 
  data.frame()

#Adiciona informações da lista de municípios em CidadesAL
CidadesAL <- merge(CidadesAL, lista_municipios, by = c("UF", "Municipio_UF"), all.x = TRUE)

#Salvando CidadesAL atualizado:
saveRDS(CidadesAL, file = here("Dados/CidadesAL.RDS"))

rm(CidadesAL)


#ALClima
#Filtra na lista de desastres os municípios presentes nas bases do SAPL
DesastresSAPL <- DesastresSAPL %>% 
  filter(Municipio_UF %in% ALClima$Municipio_UF)

saveRDS(DesastresSAPL, here("Dados/DesastresSAPL.RDS"))


# Adiciona informações de lista municípios à ALClima
ALClima <- merge(ALClima, lista_municipios, by = c("UF", "Municipio_UF"), all.x = TRUE)


#Atualizando lista de municípios só com os usados no SAPL:
lista_municipios <- ALClima %>% 
  select(Cod_IBGE_Mun, Nome_Municipio, UF, Municipio_UF) %>% 
  unique()

#Salvando bases atualizadas
saveRDS(lista_municipios, here("Dados/lista_municipios.RDS")) #Salva a lista de municípios
saveRDS(ALClima, here("Dados/ALClima.RDS")) #Salva a lista de municípios


rm(lista_municipios)
```

### Adicionando dias desde o último desastre.

A seguir adicionamos a informação sobre a distância entre a data do desastres mais recente (ou do desastre seguinte) em relação à apresentação do projeto. Esta informação irá ajudar a compreender melhor o contexto em que um projeto foi apresentado

```{r, 'dias_ultimo_desastre'}

# 1. Criando base de dados alinhando combinações de projetos e deastres que aconteceram antes deles
ALClima_prev <- ALClima %>%
  left_join(DesastresSAPL, by = "Municipio_UF", suffix = c("", "_desastre")) %>% #Cria todas as combinações de projetos e desastres por município
  filter(Data_desastre < Data) %>% #Filtra só as linhas em que a data do desastre antecede a data do projeto
  group_by(UF, Municipio_UF, Cod_IBGE_Mun, Data) %>% #Agrupa pelas informações de município e data  
  slice_max(Data_desastre, with_ties = FALSE) %>% #mantêm apenas a primeira versão de cada combinação em cada cidade
  ungroup() %>%
  select(UF, Municipio_UF, Cod_IBGE_Mun, Data, data_desastre_anterior = Data_desastre, desastre_anterior = Desastre) #Seleciona as colunas que serão integradas depois, renomeando as novas

#Repete o anterior, mas para o desastre seguinte
ALClima_next <- ALClima %>%
  left_join(DesastresSAPL, by = "Municipio_UF", suffix = c("", "_desastre")) %>%
  filter(Data_desastre >= Data) %>%
  group_by(UF, Municipio_UF, Cod_IBGE_Mun, Data) %>%
  slice_min(Data_desastre, with_ties = FALSE) %>%
  ungroup() %>%
  select(UF, Municipio_UF, Cod_IBGE_Mun, Data, data_desastre_proximo = Data_desastre, desastre_proximo = Desastre)

#Junta os arquivos na base original:
ALClima <- ALClima %>%
  left_join(ALClima_prev, by = c("UF", "Municipio_UF", "Cod_IBGE_Mun", "Data")) %>%
  left_join(ALClima_next, by = c("UF", "Municipio_UF", "Cod_IBGE_Mun", "Data")) %>%
  mutate(
    dias_desastre_anterior = as.integer(Data - data_desastre_anterior),
    dias_desastre_proximo = as.integer(Data - data_desastre_proximo)
  )

#Salva a versão atualizada da base
saveRDS(ALClima, file = here("Dados/ALClima.RDS"))

# Remove os objetos que não serão mais utilizados
rm(ALClima_prev, ALClima_next, lista_municipios, DesastresSAPL, ALClima)

```

## 1.6 Adicionando informações municipais de outras fontes

Agora que já temos uma base de dados com todas as informações, incluindo os códigos do IBGE dos municípios, podemos adicionar outras informações que serão utilizadas como controle na nossa análise.

O Senado Federal, através do "Panorama do Legislativo Municipal", compila uma série de dados de várias fontes que oferecem um bom ponto de partida.

Lista de fontes: <https://www.senado.leg.br/institucional/datasenado/panorama/#/fonte-dados>

Dados: <https://www.senado.leg.br/institucional/datasenado/panorama/#/dados>

Primeiro, iremos fazer a leitura e unir as bases de dados sugeridas:

```{r, 'subindo_bases_legis', warning=FALSE}
#Confira se os arquivos com as bases de dados CSV estão salvos na pasta "Panorama do Legislativo Municipal"

#Sobe o pacote 'purrr'
library(purrr)

# Lista todos os arquivos CSV na pasta
csv_files <- list.files(path = here("Dados/Panorama do Legislativo Municipal"), pattern = "\\.csv$", full.names = TRUE)

# Importa todos os arquivos  CSV na lista
csv_dataframes <- csv_files %>%
  set_names(~ tools::file_path_sans_ext(basename(.x))) %>% #Dá nome aos arquivos
  map(~ read_csv2(.x, locale = locale(encoding = "Latin1"))) #Replica a leitura para cada elemento do vetor de nomes

rm(csv_files)
```

```{r 'limpando_bases_legis'}
library(tidyr)

#Dados básicos do Município
csv_dataframes$municipio <- csv_dataframes$municipio %>% 
  rename("Cod_IBGE_Mun" = "Cód.")

#Dados do orçamento municipal
csv_dataframes$orcamentodomunicipio <- csv_dataframes$orcamentodomunicipio %>% 
  select(!Porcentagem) %>% 
  pivot_wider(names_from = Categoria,
              values_from = Valor, 
              names_prefix = "Orcamento_Mun ") %>% 
  rename("Cod_IBGE_Mun" = "Cod.IBGE")

#Dados sobre a Câmara de Vereadores
csv_dataframes$vereadores <- csv_dataframes$vereadores %>% 
  mutate(Municipio_UF = stri_trans_general(paste(tolower(Municipio), UF, sep = "_"), "Latin-ASCII")) %>% 
  group_by(Ano, UF, Codigo_IBGE, Municipio_UF) %>% 
  summarise(n_Vereadores = n()) %>% 
  rename("Cod_IBGE_Mun" = "Codigo_IBGE")
  
#Juntando as bases de dados:
DadosMunic <- reduce(
  csv_dataframes,
  full_join,
  by = c("Ano", "Cod_IBGE_Mun"))

saveRDS(DadosMunic, here("Dados/DadosMunic.RDS"))

rm(csv_dataframes)
```

### Dados demográficos e ecocômicos (Densidade Demográfica, Pobreza, Principais setores econômicos)

```{r}

```

### Capacidades estatais (Burocracia)

### Características climáticas (Biomas, Índices Pluviométricos) 

```{r}

```

### Número de desastres

```{r}

```

### Estações do ano

```{r}

```
