---
title: "4. Análise do efeito dos ECEs sobre a agenda"
output: html_notebook
---

# 4. Análise do efeito dos ECEs sobre a agenda

Agora que já identificamos quais os tópicos dos documentos, vamos fazer uma análise da produção em relação ao total da produção.\
\
Na primeira, faremos a análise com toda a produção que menciona os termos procurados. Na segunda, vamos nos restringir à produção em projetos de lei

## Pacotes e bases de dado

```{r}
#install.packages("viridis")
#install.packages("plm")
```

```{r, echo = FALSE, warning=FALSE}
library(dplyr)
library(here)
library(tidyr)
library(data.table)
library(stringr)
library(ggplot2)
library(lubridate)
library(viridis)
library(plm)
```

```{r, echo = FALSE}
df_ols <- readRDS(here("Dados/df_ols.RDS")) %>% 
  mutate(Dia = as.integer(Dia))
```

## 4.1 Observando as características da série

### 4.1.1 Distribuição da agenda climática

```{r}

#Heatmap
heatmap <- df_ols %>% 
  mutate(Regiao = str_sub(Cod_IBGE_Mun, 1, 1)) %>% 
  ggplot(aes(x = Data, y = Cod_IBGE_Mun)) +
  geom_tile(aes(fill = agenda_clima)) +   
  geom_tile(data = df_ols[df_ols$Desastre == 1, ], 
            aes(fill = NULL), 
            color = "red") +  
  scale_fill_viridis() +
  theme_classic() +
  theme(legend.position = "top") +
  labs(title = "Distribuição da apresentação de projetos, por município e data",
       y = "Código IBGE do Município", 
       x = "Data", 
       fill = "Percentual de projetos climáticos apresentados")
  
heatmap

ggsave(here("Figuras/4.1.1Heatmap_projetos_climaticos.png"), heatmap, height = 30, width = 10)

rm(heatmap)
```

## 4.2 Testando as condições da variável destino para análise de séries temporais

### 4.2.1 Analisando a existência de tendências na variável destino

```{r}
TesteTend <- lm(agenda_clima ~ Dia, data = df_ols)

summary(TesteTend)
```

Existe uma linha de tendência significativa, mas pequena (0,000006148)

### 4.2.2 Testes de autocorrelação serial (raiz unitária)

```{r}
# Teste de Breusch-Godfrey com "pbgtest"

TesteBG <- pbgtest(agenda_clima ~ lag(agenda_clima), data = df_ols)


TesteBG
```

O resultado sugere que não há autocorrelação serial significativa na série temporal analisada.

### 4.2.3 Testes de sazonalidade

```{r}

sazonalidade <- df_ols %>% 
  group_by(Mes) %>% 
  summarise(agenda_clima = mean(agenda_clima)) %>% 
  ggplot(aes(x = Mes, y = agenda_clima)) +
  geom_col(fill = "black")+
  theme_bw()+
  labs(title = "Percentual médio de produção legislativa relacionada ao clima, por mês",
       x= "Mês", 
       y = "Percentual de produção legislativa")+
  scale_x_continuous(n.breaks = 12)
sazonalidade
```

Como é possível observar, há um aumento do percentual de produção em políticas climáticas nos meses de verão,, em especial fevereiro e março, e uma queda considerável em dezembro.

## 4.3 Rodando a regressão com série temporal

```{r}
#Checando por autocorrelações na matriz das variáveis: 

cor_matrix <- cor(df_ols[, c("agenda_clima", "Desastre", "Obitos",
                             "dias_proxima_eleicao", "Receitas_Mun", "n_OSCs",
                             "AB2_Recursos_Hídricos_Seca", 
                             "AB2_Segurança_Alimentar_Seca", "AB2_Segurança_Alimentar_Chuva",
                             "AB2_Desastres_Hidrológicos_Inundações_enxurradas_e_alagamentos",
                             "AB2_Desastres_Hidrológicos_Deslizamento_de_terra")],
                  use = "complete.obs") %>% 
  data.table()

```

```{r}
#Checando missing values:

colSums(is.na(df_ols))

Receitas_erro <- df_ols %>% 
  filter(is.na(Receitas_Mun)) %>% 
  group_by(Cod_IBGE_Mun) %>% 
  summarise()

orcamento_sum <- orcamento %>% 
  filter(Cod_IBGE_Mun %in% Receitas_erro$Cod_IBGE_Mun,
         Ano %in% Receitas_erro$Ano)
```

\

#  PAREI AQUI

```{r}
#Remoção dos municípios sem informações de Receita Municipal:
df_ols <- df_ols %>%  filter(!Cod_IBGE_Mun %in% Receitas_erro$Cod_IBGE_Mun)

#Criando variável com lag1: 

df_ols <- df_ols[, lag_agenda_clima := shift(agenda_clima, 1, type="lag"), by = Cod_IBGE_Mun]

df_ols <- pdata.frame(df_ols, index = c("Cod_IBGE_Mun", "Dia"))
  

modelo1 <- plm(agenda_clima ~ lag(agenda_clima) + 
                 Desastre + Obitos +
                 dias_proxima_eleicao +  
                 Receitas_Mun + n_OSCs + 
                 AB2_Recursos_Hídricos_Seca + 
                 AB2_Segurança_Alimentar_Seca + AB2_Segurança_Alimentar_Chuva +
                 AB2_Desastres_Hidrológicos_Inundações_enxurradas_e_alagamentos +
                 AB2_Desastres_Hidrológicos_Deslizamento_de_terra, 
               data = df_ols, model = "pooling")

summary(modelo1)
```

### Teste de autocorrelação nas unidades (Pesaran)

```{r}

TestePesaran1 <- pcdtest(modelo1, test = "cd")
print(cd_test)
```

### Teste de autocorrelação serial de Durbin-Watson

```{r}
#Teste de Durbin-Watson:
TesteDW1 <- pdwtest(modelo1)
```
